---
title: 讨厌的文本选区
date: 2011-03-11 17:31:00
tags: [JS,小工具,富文本编辑器]
---


喜欢直奔主题的同学可略过介绍和分析，直接copy去吧，代码都是function式的，看效果可以直接以 fun.call(element,arg....) 调用。

Ctrl+End直奔页尾吧~

文本选区的操作可能是WEB前端的一个比较郁闷的地方。

我想有时候想自己写个编辑器，设置编辑器中的文本为特定的样式就是一个很大的难点。

看书上写的也是云里雾里的，于是自己动手写吧，资料还是找官方的。

首先我啥也不知道。列出一个我需要的功能。


1. 获得我选中的文本值
2. 获得当前的位置
3. 替换、删除选中的值
4. 在固定的位置插入值
5. 设置光标所在的位置
6. 选中一个段文本

首先开始百度谷歌，不过情况都不太好，不给力。代码都含糊不清。但是搜索到一个有用的信息：IE浏览器的 Range 和非IE浏览器的 Range 实现方式不一致。

搜索到的代码就不列出了，现就最后 的实现代码做分析。

````javascript
//    取得选中的值    
//    参数            
//    返回    String:"Range Text"
 function getRngVal(){
    if(    document.selection &&(document.selection.type=='Text')){
    //    IE处理
     //    document.selection 是IE下特有的在这里侦测了下选中的是否是文本
         var rng = document.selection.createRange();
        //    整个文档选取创建了一个  Range  对象，注意不是 TextRange，此时的rng.text是整个页面内所有的文本

        //    如果选取的文本区域不是从当前对象选取的话就返回一个空
         if (rng.parentElement() != this){
            return "";
        }
        //    否则返回选中的文本段落
         return document.selection.createRange().text;
    }
    //    非IE处理
     if(this.selectionStart != undefined && this.selectionEnd != undefined) {
        //    验证下，有没有选中文字

        //    这里比较简单了直接获得选取文字的头尾（所在的字符位置）然后substring返回
         var s = this.selectionStart;
        var e = this.selectionEnd;
        return this.value.substring(s,e);
    }else {return ""};
}
````

已经可以取得选取的文本的信息了，接下去看下如何获得文本所在的位置，相信看过上面的代码了，非IE浏览器直接获得 this.selectionStart; this.selectionEnd;就可以了。IE呢？

```` javascript
//    取得光标位置
//    参数
//    返回    array :[start,end]
 function getRngPos(){
    var pos = [0,0];
    if(typeof this.selectionStart == 'number'){
        pos[0] = this.selectionStart;
        pos[1] = this.selectionEnd;
    }
    else{
        //    曲折的IE
         var dng = document.selection.createRange();
        //    如果选中的文本长度为空
         //    先聚焦到对象中，再去设置选区
         if(dng.text.length<1){
            txt.focus();
            dng = document.selection.createRange();
        }
        //    如果选取的文字所在对象不是当前对象
        //    退
        if (dng.parentElement() != this){
            return pos;
        }
        var tng = this.createTextRange();
        var al = tng.text.length;
        //    IE处理光标范围在最后一个总是会报“未指定的错误”，没办法，只好把他拉到 try 中来了
        try{
        //    移动选取到光标所在的位置(像素)
        tng.moveToPoint(dng.offsetLeft,dng.offsetTop);
        }
        catch(e){
            return [al,al];
        }
        //    IE中，移动选取范围从当前位置到整个字符的长度
        //    后面是计算了，开始的位置就是，所有字符，剪掉移动后的字符，后的长度
        //    结束的位置就是，所有字符，剪掉移动后的字符，再加上选取的字符本身的长度
        tng.moveEnd('character',al);
        pos[0] = al-tng.text.length;
        pos[1] = al-tng.text.length+dng.text.length;
    }
    return pos;
}
````

设置部分下回再说。 ^_^

[在线演示](/demo/textareaRange.html)
